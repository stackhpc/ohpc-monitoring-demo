---

prometheus_external_address: "{{ ansible_host }}"
prometheus_web_external_url: "http://{{ prometheus_external_address }}:9090"
prometheus_storage_retention: "31d"

prometheus_alertmanager_config:
  - scheme: http
    static_configs:
      - targets:
        - "{{ prometheus_exporter_listen_address }}:9093"

# remove localhost from all group
__all_groups: "{{ groups['all'] | select('match', '^(?!localhost).*') | list }}"

prometheus_targets:
  node:
    - targets:
        "{{ __all_groups | map('extract', hostvars, ['prometheus_exporter_listen_address']) | map('regex_replace', '$', ':9100') | list }}"
      labels:
        cluster: euclid
  slurm:
    - targets:
         "{{ groups['slurm_exporter'] | map('extract', hostvars, ['prometheus_exporter_listen_address']) | map('regex_replace', '$', ':1234') | list }}"
  alertmanager:
    - targets:
      - "{{ prometheus_exporter_listen_address }}:9093"
      labels:
        cluster: euclid
  grafana:
    - targets:
      - "{{ prometheus_exporter_listen_address }}:3000"
      labels:
        cluster: euclid
  ceph:
    - targets:
        "{{ groups['ceph_mgr'] | map('extract', hostvars, ['prometheus_exporter_listen_address']) | map('regex_replace', '$', ':9283') | list }}"
      labels:
        cluster: euclid

  sockpuppet:
    - targets:
        "{{ groups['cluster_gw'] | map('extract', hostvars, ['prometheus_exporter_listen_address']) | map('regex_replace', '$', ':30000') | list }}"
      labels:
        group: cluster_gw
    - targets:
        "{{ groups['cluster_ceph_osd'] | map('extract', hostvars, ['prometheus_exporter_listen_address']) | map('regex_replace', '$', ':30000') | list }}"
      labels:
        group: cluster_ceph_osd
    - targets:
        "{{ groups['cluster_ceph_mon'] | map('extract', hostvars, ['prometheus_exporter_listen_address']) | map('regex_replace', '$', ':30000') | list }}"
      labels:
        group: cluster_ceph_mon
    - targets:
        "{{ groups['cluster_ceph_mds'] | map('extract', hostvars, ['prometheus_exporter_listen_address']) | map('regex_replace', '$', ':30000') | list }}"
      labels:
        group: cluster_ceph_mds

prometheus_scrape_configs:
- job_name: "prometheus"
  metrics_path: "/metrics"
  static_configs:
  - targets:
    - "{{ prometheus_external_address }}:9090"
- job_name: "node"
  file_sd_configs:
  - files:
    - "/etc/prometheus/file_sd/node.yml"
- job_name: "alertmanager"
  file_sd_configs:
  - files:
    - "/etc/prometheus/file_sd/alertmanager.yml"
- job_name: "grafana"
  file_sd_configs:
  - files:
    - "/etc/prometheus/file_sd/grafana.yml"
- job_name: 'blackbox'
  metrics_path: /probe
  params:
    module: [http_2xx]
  static_configs:
    - targets:
      - "http://{{ prometheus_exporter_listen_address }}:9100"
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: 127.0.0.1:9115  # Blackbox exporter.
- job_name: fcos-updates-stg
  metrics_path: /metrics
  scheme: https
  static_configs:
    - targets:
      - "status.updates.coreos.stg.fedoraproject.org"
- job_name: slurm
  scrape_interval: 30s
  scrape_timeout: 30s
  file_sd_configs:
  - files:
    - "/etc/prometheus/file_sd/slurm.yml"
- job_name: ceph
  scrape_interval: 30s
  scrape_timeout: 30s
  file_sd_configs:
  - files:
    - "/etc/prometheus/file_sd/ceph.yml"
- job_name: sockpuppet
  scrape_interval: 10s
  scrape_timeout: 10s
  file_sd_configs:
  - files:
    - "/etc/prometheus/file_sd/sockpuppet.yml"

alertmanager_external_url: "http://{{ prometheus_external_address }}:9093"
alertmanager_slack_api_url: "{{ vault_slack_webhook }}"
alertmanager_receivers:
- name: slack
  slack_configs:
  - send_resolved: true
    channel: '#euclid-alerts'
alertmanager_route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: slack

grafana_security:
  admin_user: admin
  admin_password: "{{ vault_grafana_password }}"

grafana_auth:
  anonymous:
    org_name: "Main Org."
    org_role: Viewer

grafana_datasources:
  - name: "Prometheus"
    type: "prometheus"
    access: "proxy"
    url: "http://{{ prometheus_external_address }}:9090"
    isDefault: true
grafana_dashboards:
  - dashboard_id: '1860'
    revision_id: '12'
    datasource: '{{ grafana_datasources.0.name }}'
  - dashboard_id: '3662'
    revision_id: '2'
    datasource: '{{ grafana_datasources.0.name }}'
  - dashboard_id: '4271'
    revision_id: '4'
    datasource: '{{ grafana_datasources.0.name }}'
  - dashboard_id: '4323'
    revision_id: '2'
    datasource: '{{ grafana_datasources.0.name }}'
  # openHPC dashboard
  - dashboard_id: '10809'
    revision_id: '2'
    datasource: '{{ grafana_datasources.0.name }}'
  # Ceph cluster overview
  - dashboard_id: '7056'
    revision_id: '2'
    datasource: '{{ grafana_datasources.0.name }}'
